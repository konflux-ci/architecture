# Secret Management For User Workloads

Date: 2022-10-28

## Status

Accepted

## Context

When user workloads are deployed to environments, the system should be able to provide a way to inject values that is specific to the environment. Today, this is done through environment variables that are managed as overlays on the GitOps repository for the application. However, this method does not provide a good way to manage secrets. This ADR addresses the secret management of user workloads for different environments.

## Decision

### Architecture Overview

All user workloads are synced through GitOps service to their environments. StoneSoup's GitOps service uses the [Argo CD Vault Plugin (AVP)](https://github.com/argoproj-labs/argocd-vault-plugin) to replace secret values from the supported secret management backends.

AppStudio will provide a default secret management backend (the default backend) that will be used to store the secrets by default. When a GitOps repository is generated by the application service templates should already be ready for secret use.
![](../diagrams/secret-mgmt.excalidraw.svg)

#### Secret management APIs
An API is provided to create and update secrets on the default backend. This is a REST-based API similar to [SPI token management API](https://github.com/redhat-appstudio/service-provider-integration-operator/blob/main/docs/USER.md#post-tokennamespacename). The secrets are per component and can be varied per environment. Only workspace owners can create and update secrets.

#### The default secret management backend
**TODO:** Add the default backend and its deployment shape.

#### Bring Your Own Secret Management
Applications can use secret management backends other than the default secret management backend. However, this requires the GitOps service to provide single-tenant ArgoCD instances. The supported backends will be limited to those supported by [AVP as documented](https://argocd-vault-plugin.readthedocs.io/en/stable/backends/). Creating and updating secrets through StoneSoup secret management REST APIs is not supported for custom backends.

### Integration with Other Services

#### Application Service
Application Service provides an API like the one that it provides for environment variables that similarly updates the secrets. Unlike environment variables, the secret provided by users is saved to the secret management backend.

#### GitOps templates
The GitOps templates use [inline-path placeholders](https://argocd-vault-plugin.readthedocs.io/en/stable/howitworks/#inline-path-placeholders) like `<path:some/path#secret-key>`

### Security and Access Control

Only workspace maintainers can create and update secrets on a workspace on the default secret management backend.

The secrets are read and injected only at the GitOps service during sync. No other parts of the system have read access to the secret backend. Every application is authenticated separately on the secret management backend service. Only application credentials have read access to secrets.

### Monitoring and Auditing

For the default backend and the REST API

* Monitoring of access and usage of secrets: The default secret backend should monitor and track access and usage of secrets to detect and prevent unauthorized access or misuse. This may include monitoring of user and application access to secrets, as well as tracking of secret usage and access patterns.

* Auditing of secret access and usage: The default secret backend should maintain an audit log of all secret access and usage, to provide a record of who accessed and used secrets, when, and for what purpose.

* Alerting and notification of security issues: The default security backend should provide alerting and notification mechanisms to alert security administrators and other stakeholders of potential security issues or incidents. This may include alerts for unauthorized access or misuse of secrets, as well as alerts for other security-related events or issues.

In the case of custom secret management backends, the monitoring and auditing will not extend to the actual backend and be limited to REST API and GitOps service logs.




## Consequences
