# ADR-0056: Schema-Governed Correlation ID for Workflow Traceability

## Status

Proposed

## Context

Konflux CI orchestrates multi-stage workflows involving Build PipelineRuns for individual `Component` resources, followed by creation and reconciliation of `Snapshot` resources, execution of `IntegrationTestScenario` PipelineRuns, and finally Release CRs and Release PipelineRuns. Although these steps represent a single logical workflow, Konflux currently lacks a deterministic way to correlate all PipelineRuns generated by the same webhook event or logical change.

Tekton’s built-in identifiers (such as event IDs) are random and cannot be reproduced. CEL templates can extract event metadata but cannot compute stable hashes. PipelineRuns may be short-lived or created in remote clusters, preventing reliable correlation based on their presence in the cluster. Downstream observability systems that consume PipelineRun CloudEvents require a durable, deterministic identifier spanning the full Build -> Integration -> Release lifecycle.

A correlation mechanism is needed that is deterministic across retries and replays, configurable on a per-namespace basis, SCM-agnostic, and capable of expressing both single-event and multi-event fan-in, all without modifying existing CRDs. Because the correlation-id is a deterministic function of a configurable set of SCM fields (e.g. provider, repo, PR number, commit SHA), operators can define what constitutes a ‘unit of work’ (per webhook, per PR+commit, etc.) and use correlation-id as a stable join key in observability systems. This enables per-change or per-delivery latency metrics (e.g. commit -> first successful integration) without PaC needing to know anything about specific downstream controllers.

## Decision / Proposal

Konflux introduces a **schema-governed correlation identifier** carried through the system using a single label:

```
pipelinesascode.tekton.dev/correlation-id
```

Two identifiers are defined:

**Event Correlation ID (ECID).**
Generated by Pipelines-as-Code (PaC) per webhook event. Each namespace may define a `konflux-correlation-policy` Secret containing a UUIDv5 namespace, a selected set of normalized SCM fields (provider, repository, commit, PR number, event ID, etc.), and a canonical JSON template. PaC watches and caches this policy; for each webhook event, it normalizes the selected fields, renders the template, computes a UUIDv5 hash, and labels all PipelineRuns created for that event with the resulting ECID.

**Snapshot Correlation ID (SCID).**
Generated by integration-service when a Snapshot contains components produced from multiple ECIDs. When a Build PipelineRun completes, integration-service reads the ECID label from that PipelineRun and, as part of updating the corresponding Component with the latest image/commit information, persists the ECID into the Component’s metadata (for example, as an annotation). When integration-service later reconciles a Snapshot, it reads these ECIDs from the relevant Components and uses them as the per-component provenance for that Snapshot. On reconciliation, if all components share the same ECID, that value becomes the Snapshot’s correlation ID; if multiple ECIDs are present, integration-service computes a UUIDv5 over the sorted distinct ECIDs and uses it as the SCID. Parent ECIDs are stored in paged Snapshot annotations along with page count, total count, and a fingerprint.

The resulting correlation ID - ECID or SCID - is applied to the Snapshot, all IntegrationTestScenario PipelineRuns, and any Release CRs integration-service creates. release-service already propagates labels and annotations from Snapshot -> Release CR -> Release PipelineRun, so no changes are required there. No CRD schemas are modified; all correlation data resides in annotations and labels on existing Konflux resources.

## Consequences

### Positive

* Establishes **deterministic, end-to-end correlation** linking Build, Integration, and Release PipelineRuns generated by the same logical change.
* Enables consistent grouping of CloudEvents, logs, and metrics in downstream **observability and analytics systems**.
* Allows **per-namespace configuration** of correlation semantics, letting teams define what constitutes “the same change” (e.g., per-event or per-PR+commit) without cross-project impact.
* Requires **no CRD schema changes** and no mutation of historical PipelineRuns.
* Compatible with **multi-cluster** deployments and **resilient to PipelineRun garbage collection**, because ECIDs are preserved in Component metadata and Snapshots.
* Provides explicit **fan-in lineage** through parent ECID annotations on Snapshots, improving visibility for multi-event workflows.

### Negative / Tradeoffs

* **Rotation of the correlation-policy namespace UUID** alters correlation semantics and is therefore discouraged; correlation policy updates require careful operational handling.
* Paged annotation storage for parent ECIDs increases Snapshot size and introduces additional **etcd storage, I/O, and controller payload overhead**, especially in high fan-in scenarios.
* SCID roll-up and annotation paging introduce **moderate implementation complexity** within Integration.
* External systems relying on parent ECID annotations must account for **reconciliation timing**, as these annotations appear only after the Snapshot reconcile phase.

---

## Outcome

Konflux gains a robust, deterministic correlation mechanism that cleanly links all PipelineRuns associated with a logical change while remaining fully compatible with existing CRDs and controller flows. build-service, integration-service, and release-service continue to operate with minimal changes, and downstream systems can reliably group workflow activity using a single, stable identifier. The approach balances flexibility, observability, and operational efficiency while preserving the existing Konflux resource model.
